import{ref as e,onMounted as a,onBeforeUnmount as l,watch as o,openBlock as n,createElementBlock as t,Fragment as i,createElementVNode as u,normalizeClass as r,createTextVNode as s,toDisplayString as v,createCommentVNode as c,normalizeStyle as d,onUnmounted as g,resolveComponent as p,withDirectives as f,vShow as m,createBlock as y}from"vue";var h={name:"CustomWaveForm",props:{updateIsplaying:{type:Function,required:!1},audioUrl:{type:String,required:!0},showPlayButton:{type:Boolean,default:!0},waveColor:{type:String,default:"#4F4A85"},progressColor:{type:String,default:"#383351"}},setup(n){const t=e(null),i=e(null),u=e(null),r=e(!1),s=e(0),v=e(0),c=e(0),d=e([]),g=e(0),p=e(0),f=e(null),m=e(0),y=e(null),h=async()=>{try{t.value=new(window.AudioContext||window.webkitAudioContext);const e=await fetch(n.audioUrl),a=await e.arrayBuffer();i.value=await t.value.decodeAudioData(a),c.value=i.value.duration,await w()}catch(e){console.error("Error initializing audio:",e)}},w=async()=>{const e=i.value.getChannelData(0),a=Math.floor(e.length/1e3);d.value=[];for(let l=0;l<1e3;l++){const o=a*l;let n=0;for(let l=0;l<a;l++){const a=Math.abs(e[o+l]);a>n&&(n=a)}d.value.push(n)}b()},C=()=>{const e=y.value,a=e.parentElement;g.value=a.clientWidth,p.value=a.clientHeight,e.width=g.value,e.height=p.value,b()},b=()=>{if(!d.value.length||!y.value)return;const e=y.value,a=e.getContext("2d"),l=e.width,o=e.height;a.clearRect(0,0,l,o);const t=l/d.value.length,i=.2;if(a.fillStyle=n.waveColor,d.value.forEach(((e,l)=>{const n=l*t,u=e*o;a.fillRect(n+t*i/2,(o-u)/2,.8*t,u)})),v.value>0){const e=v.value/c.value;a.fillStyle=n.progressColor,d.value.forEach(((n,u)=>{const r=u*t;if(r/l<=e){const e=n*o;a.fillRect(r+t*i/2,(o-e)/2,.8*t,e)}}))}},S=()=>{i.value&&(u.value=t.value.createBufferSource(),u.value.buffer=i.value,u.value.connect(t.value.destination),s.value=t.value.currentTime-v.value,u.value.start(0,v.value),r.value=!0,n.updateIsplaying&&n.updateIsplaying(r.value),R())},k=()=>{u.value&&(u.value.stop(),u.value=null),f.value&&cancelAnimationFrame(f.value),r.value=!1,n.updateIsplaying&&n.updateIsplaying(r.value)},R=()=>{f.value=requestAnimationFrame(R),r.value&&(v.value=t.value.currentTime-s.value,v.value>=c.value&&(k(),v.value=0),m.value=v.value/c.value*g.value,b())},A=()=>{C()},P=()=>{u.value&&u.value.stop(),f.value&&cancelAnimationFrame(f.value),t.value&&t.value.close()};return a((async()=>{await h(),C(),window.addEventListener("resize",A)})),l((()=>{P(),window.removeEventListener("resize",A)})),o((()=>n.audioUrl),(async()=>{P(),await h()}),{deep:!0}),{isPlaying:r,currentTime:v,duration:c,progressPosition:m,waveformCanvas:y,togglePlayPause:()=>{r.value?k():S()},handleCanvasClick:e=>{const a=e.target.getBoundingClientRect(),l=(e.clientX-a.left)/g.value*c.value;v.value=l,r.value?(k(),S()):(m.value=v.value/c.value*g.value,b())},handleMouseMove:e=>{},formatTime:e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}}};const w={class:"waveform-container"},C={class:"controls"},b={class:"time"};h.render=function(e,a,l,o,g,p){return n(),t(i,null,[u("div",null,[l.showPlayButton?(n(),t("button",{key:0,class:"btn btn-success",onClick:a[0]||(a[0]=(...e)=>o.togglePlayPause&&o.togglePlayPause(...e))},[u("span",{class:r(o.isPlaying?"icon-pause":"icon-play")},null,2),s(" "+v(o.isPlaying?"Pause Recording":"Play Recording"),1)])):c("v-if",!0)]),u("div",w,[u("canvas",{ref:"waveformCanvas",class:"waveform",onClick:a[1]||(a[1]=(...e)=>o.handleCanvasClick&&o.handleCanvasClick(...e)),onMousemove:a[2]||(a[2]=(...e)=>o.handleMouseMove&&o.handleMouseMove(...e))},null,544),o.isPlaying||o.currentTime>0?(n(),t("div",{key:0,class:"progress-bar",style:d({left:o.progressPosition+"px"})},null,4)):c("v-if",!0)]),u("div",C,[u("span",b,v(o.formatTime(o.currentTime))+" / "+v(o.formatTime(o.duration)),1)])],64)},h.__file="src/components/CustomWaveForm.vue";var S={name:"AudioRecorder",components:{CustomWaveForm:h},props:{showSaveButton:{type:Boolean,required:!1,default:!1}},setup(l,{emit:o}){const n=e(null),t=e(!1);e(null);const i=e(0),u=e(null),r=e(!0),s=e(!1),v=e(null),c=e(null),d=e(!1),p=e(!1),f=e(0),m=e([]),y=e(null),h="#4F4A85",w="#f5f5f5",C=.2,b=e(null);e(null);const S=e(null),k=e(null),R=e(null),A=e(null),P=e(null),F=e(null),M=async e=>{v.value=null,k.value=new(window.AudioContext||window.webkitAudioContext),R.value=k.value.createAnalyser(),P.value=k.value.createMediaStreamSource(e),P.value.connect(R.value),R.value.fftSize=2048;const a=R.value.frequencyBinCount;A.value=new Uint8Array(a);const o=["audio/webm","audio/mp4;codecs=aac","audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/wav","audio/ogg"].find((e=>MediaRecorder.isTypeSupported(e)))||"";S.value=new MediaRecorder(e,{mimeType:o}),m.value=[],S.value.ondataavailable=e=>{m.value.push(e.data)},S.value.onstop=()=>{y.value=new Blob(m.value,{type:"audio/webm"}),v.value=URL.createObjectURL(y.value),P.value.disconnect(),cancelAnimationFrame(F.value),D(!l.showSaveButton)},S.value.start(),s.value=!0,T(),x()},U=async()=>{if(t.value=!1,s.value)L();else try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});await M(e)}catch(e){c.value="Error accessing microphone: "+e.message}o("update-save-button",!!v.value)},L=()=>{S.value&&s.value&&(S.value.stop(),s.value=!1,B())},D=async(e=!0)=>{if(y.value){c.value=null;try{e&&o("recording-complete",{file:y.value})}catch(e){c.value=e.message,console.error("Save error:",e)}finally{u.value&&clearInterval(u.value),f.value=0}}},T=()=>{i.value=300,u.value=setInterval((()=>{i.value--,i.value<1&&L()}),1e3)},B=()=>{u.value&&clearInterval(u.value)},x=()=>{const e=b.value;if(!e)return;const a=e.getContext("2d"),l=e.width,o=e.height,n=()=>{F.value=requestAnimationFrame(n),R.value.getByteFrequencyData(A.value),a.fillStyle=w,a.fillRect(0,0,l,o);const e=A.value.length,t=l/2/e,i=o/2;for(let n=0;n<e;n++){const e=A.value[n]/255*(o/2),u=l/2-n*t-t,r=l/2+n*t,s=a.createLinearGradient(u,i-e,u,i+e);s.addColorStop(0,h),s.addColorStop(.5,h+"80"),s.addColorStop(1,h);const v=a.createLinearGradient(r,i-e,r,i+e);v.addColorStop(0,h),v.addColorStop(.5,h+"80"),v.addColorStop(1,h),a.fillStyle=s,a.fillRect(u+t*C/2,i-e,.8*t,2*e),a.fillStyle=v,a.fillRect(r+t*C/2,i-e,.8*t,2*e)}};n()};return a((async()=>{try{if(b.value){const e=b.value,a=e.getContext("2d");a.fillStyle=w,a.fillRect(0,0,e.width,e.height),a.strokeStyle=h,a.lineWidth=2,a.setLineDash([5,5]);const l=e.height/2;a.beginPath(),a.moveTo(0,l),a.lineTo(e.width,l),a.stroke(),a.setLineDash([])}}catch(e){c.value="Failed to initialize canvas: "+e.message}})),g((()=>{v.value&&URL.revokeObjectURL(v.value),F.value&&cancelAnimationFrame(F.value),k.value&&k.value.close()})),{childFormRef:n,showEditConfirmationDialog:t,timer:i,isLoaded:r,recording:s,audioUrl:v,error:c,isPlaying:d,converting:p,conversionProgress:f,visualizer:b,openConfirmationDialog:()=>{v.value?t.value=!0:(t.value=!1,U())},toggleRecording:U,handleSave:D,formatTime:e=>`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`,updateIsplaying:e=>{d.value=e},playAudio:async()=>{v.value&&await n.value.togglePlayPause()}}}};const k={class:"audio-recorder"},R={key:0,class:"dialog-overlay"},A={class:"dialog-container"},P={class:"dialog-footer"},F={key:1,class:"skeleton"},M={key:2,class:"control-container"},U={class:"control-row"},L={class:"button-group"},D=["disabled"],T={key:0,class:"timer"},B={key:3,class:"dialog-overlay"},x={class:"waveform-container"},E={ref:"visualizer",class:"wave-canvas",width:"690",height:"200"},I={key:5,class:"message error"};S.render=function(e,a,l,o,i,d){const g=p("custom-wave-form");return n(),t("div",k,[c(" Confirmation Dialog "),o.showEditConfirmationDialog?(n(),t("div",R,[u("div",A,[a[7]||(a[7]=u("div",{class:"dialog-header"},[u("h3",null,"Confirm")],-1)),a[8]||(a[8]=u("div",{class:"dialog-content"},[u("div",{class:"warning-icon"},"!"),u("span",null," Are you sure you wish to overwrite your current recording? ")],-1)),u("div",P,[u("button",{class:"btn btn-text",onClick:a[0]||(a[0]=e=>o.showEditConfirmationDialog=!1)},a[5]||(a[5]=[u("span",{class:"icon-close"},null,-1),s(" No ")])),u("button",{class:"btn btn-primary",onClick:a[1]||(a[1]=(...e)=>o.toggleRecording&&o.toggleRecording(...e))},a[6]||(a[6]=[u("span",{class:"icon-check"},null,-1),s(" Yes ")]))])])])):c("v-if",!0),o.isLoaded?c("v-if",!0):(n(),t("div",F)),o.isLoaded?(n(),t("div",M,[u("div",U,[u("div",L,[o.audioUrl?(n(),t("button",{key:0,class:"btn btn-success play-button",onClick:a[2]||(a[2]=(...e)=>o.playAudio&&o.playAudio(...e))},[u("span",{class:r(o.isPlaying?"icon-pause":"icon-play")},null,2),s(" "+v(o.isPlaying?"Pause Recording":"Play Recording"),1)])):c("v-if",!0),u("button",{class:r(["btn",o.recording?"btn-danger":"btn-primary"]),onClick:a[3]||(a[3]=(...e)=>o.openConfirmationDialog&&o.openConfirmationDialog(...e))},[u("span",{class:r(o.recording?"icon-stop":"icon-microphone")},null,2),s(" "+v(o.recording?"Stop Recording":"Start Recording"),1)],2),l.showSaveButton?(n(),t("button",{key:1,class:"btn btn-primary",disabled:!o.audioUrl,onClick:a[4]||(a[4]=e=>o.handleSave(!0))},a[9]||(a[9]=[u("span",{class:"icon-save"},null,-1),s(" Save Audio ")]),8,D)):c("v-if",!0)]),o.audioUrl?c("v-if",!0):(n(),t("div",T,[a[10]||(a[10]=u("span",{class:"clock-icon"},null,-1)),u("span",null,v(o.formatTime(o.timer)),1)]))])])):c("v-if",!0),c(" Converting Dialog "),o.converting?(n(),t("div",B,a[11]||(a[11]=[u("div",{class:"dialog-container"},[u("div",{class:"dialog-header"},[u("h3",null,"Converting Audio")]),u("div",{class:"conversion-progress"},[u("div",{class:"progress-bar-indeterminate"})])],-1)]))):c("v-if",!0),f(u("div",x,[u("canvas",E,null,512)],512),[[m,o.isLoaded&&!o.audioUrl]]),o.isLoaded&&o.audioUrl?(n(),y(g,{key:4,ref:"childFormRef","audio-url":o.audioUrl,"update-isplaying":o.updateIsplaying,"show-play-button":!1,"wave-color":"#4F4A85","progress-color":"#383351"},null,8,["audio-url","update-isplaying"])):c("v-if",!0),o.error?(n(),t("div",I,v(o.error),1)):c("v-if",!0)])},S.__file="src/components/AudioRecorder.vue";var q={install:e=>{e.component("AudioRecorder",S),e.component("CustomWaveForm",h)}};export{S as AudioRecorder,h as CustomWaveForm,q as default};
